<!DOCTYPE HTML>
<!-- Copyright (C) 2014-5 paul@marrington.net, see /GPL for license -->
<html>
<head>
  <script>
    // one global to rule them all
    window.roaster = { opts: {}, cache: {} }
    
    // temporary messaging until ui loads
    window.message = function(msg) {
      if (console) console.log(msg);
      message.messages.push(msg);
    };
    // so the UI can catch up on early messages
    window.message.messages = []
    
    // node-like require must be synchronous
    window.require = function(name) {
      if (require.cache[name]) return require.cache[name];
      var url = name;
      if (url[0] === '.' && url[1] === '/') {
        url = url.slice(2); // relative
      } else if (url[0] !== '/') {
        url = '/' + url;    // absolute
      }
      if (url.indexOf('.') === -1) {
        url += ".require";
      } else {
        url += ".client";
      }
      require.code(url);
      return require.cache[name];
    };
    require.cache = roaster.cache;
    
    require.cache.npm = function(name, next) {
      if (require.cache[name]) return next( null, require.cache[name]);
      require.server({url: '/'+name+".require"}, function(err, code) {
        require.element('script', code+"\n//# sourceURL="+name);
        next( null, require.cache[name]);
      });
    }
    
    // server is async and loads from upstream service
    require.server = function(opts, on_load) {
      var server = require.server.prepare(opts, true);
      server.request.onload = function() {
        var lm = null;
        if (opts.last_modified) {
          lm = server.request.getResponseHeader("Last-Modified");
          lm = Date.parse(lm)
        }
        on_load(null, server.response(), lm);
      };
      server.request.onerror = function(err) {
        on_load(err);
      }
      server.request.send();
    };
    // sync server is used for resource
    require.server.sync = function(opts) {
      var server = require.server.prepare(opts, false);
      server.request.send();
      return server.response();
    };
    // internal: prepare for server calls (async or sync)
    require.server.prepare = function(opts, async) {
      var server = {opts: opts};
      if (opts.url.indexOf('.') === -1) opts.url += '.script';
      server.request = new XMLHttpRequest();
      server.request.open(opts.type || 'GET', opts.url, async);
      // prepare information returned from the server
      server.response = function() {
        if (server.request.status !== 200) return null;
        return server.request.responseText
      };
      return server;
    };
    // used when server data maps to DOM elements (script, css)
    require.element = function(type, contents) {
      var element = document.createElement(type);
      try {
        element.appendChild(document.createTextNode(contents));
      } catch (e) {
        element.text = contents;
      }
      document.head.appendChild(element);
    };
    // resource in javascript - telling roaster it is for client
    require.code = function(url) {
      var code = require.server.sync({url:url+'?domain=client'});
      require.element('script', code+"\n//# sourceURL="+url);
    };
    // resource in javascript - telling roaster it is for client
    require.script = function(url) {
      var code = require.server.sync({url:url+'?domain=client,library'});
      require.element('script', code+"\n//# sourceURL="+url);
    };
    // At last we have enough to move into the real system
    window.addEventListener("load", function() {require("bootstrap");}, false);
  </script>
</head>
<body></body>
</html>